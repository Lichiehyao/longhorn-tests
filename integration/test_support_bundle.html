<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>tests.test_support_bundle API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>tests.test_support_bundle</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import pytest

from common import apps_api  # NOQA
from common import client  # NOQA

from common import check_all_support_bundle_managers_deleted
from common import create_support_bundle
from common import delete_and_wait_deployment
from common import download_support_bundle
from common import get_all_support_bundle_manager_deployments
from common import update_setting
from common import wait_for_support_bundle_cleanup
from common import wait_for_support_bundle_state

from common import SETTING_SUPPORT_BUNDLE_FAILED_LIMIT


@pytest.mark.support_bundle   # NOQA
def test_support_bundle_should_delete_after_download(client):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle should delete after download

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support bundle created
    And support bundle is in ReadyToDownload state

    When download support bundle
    Then support bundle is downloaded
    And support bundle should be deleted
    And support bundle manager should be deleted

    &#34;&#34;&#34;
    resp = create_support_bundle(client)
    node_id = resp[&#39;id&#39;]
    name = resp[&#39;name&#39;]

    wait_for_support_bundle_state(&#34;ReadyForDownload&#34;, node_id, name, client)

    download_support_bundle(node_id, name, client)

    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()


@pytest.mark.support_bundle   # NOQA
def test_support_bundle_should_error_when_failed(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle should error when failed

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 1
    And support bundle created
    And support bundle is in Generating state

    When delete support bundle manager deployment
    Then support bundle should be in state Error

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;1&#34;)

    create_failed_support_bundles(client, apps_api)


@pytest.mark.support_bundle   # NOQA
def test_support_bundle_failed_limit(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle failed limit

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 2
    And 2 failed support bundle created

    When create support bundle
    Then should fail to create

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;3&#34;)
    create_failed_support_bundles(client, apps_api, number=2)

    try:
        create_failed_support_bundles(client, apps_api, number=1)
        assert False, \
            f&#39;expect to fail exceeding {SETTING_SUPPORT_BUNDLE_FAILED_LIMIT}&#39;
    except Exception:
        pass


@pytest.mark.support_bundle   # NOQA
def test_support_bundle_purge(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 2
    And 2 failed support bundle created

    When set support-bundle-failed-history-limit setting to 0
    Then failed support bundles should be deleted
    And support bundle managers should be deleted

    When create a failed support bundle
    Then failed support bundle should be deleted
    And support bundle manager should be deleted

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;2&#34;)
    create_failed_support_bundles(client, apps_api, number=2)

    support_bundles = client.list_support_bundle()
    assert len(support_bundles) == 2

    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;0&#34;)
    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()

    # Will try to catch the Error state here because it is an intermediate
    # state
    try:
        create_failed_support_bundles(client, apps_api, number=1)
    except AssertionError:
        pass

    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()


def create_failed_support_bundles(client, apps_api, number=1):  # NOQA
    for _ in range(0, number):
        resp = create_support_bundle(client)
        node_id = resp[&#34;id&#34;]
        name = resp[&#34;name&#34;]
        wait_for_support_bundle_state(&#34;Generating&#34;, node_id, name, client)

        deployments = get_all_support_bundle_manager_deployments(apps_api)
        delete_and_wait_deployment(
            apps_api, deployments[0].metadata.name,
            namespace=deployments[0].metadata.namespace
        )
        wait_for_support_bundle_state(&#34;Error&#34;, node_id, name, client)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="tests.test_support_bundle.create_failed_support_bundles"><code class="name flex">
<span>def <span class="ident">create_failed_support_bundles</span></span>(<span>client, apps_api, number=1)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_failed_support_bundles(client, apps_api, number=1):  # NOQA
    for _ in range(0, number):
        resp = create_support_bundle(client)
        node_id = resp[&#34;id&#34;]
        name = resp[&#34;name&#34;]
        wait_for_support_bundle_state(&#34;Generating&#34;, node_id, name, client)

        deployments = get_all_support_bundle_manager_deployments(apps_api)
        delete_and_wait_deployment(
            apps_api, deployments[0].metadata.name,
            namespace=deployments[0].metadata.namespace
        )
        wait_for_support_bundle_state(&#34;Error&#34;, node_id, name, client)</code></pre>
</details>
</dd>
<dt id="tests.test_support_bundle.test_support_bundle_failed_limit"><code class="name flex">
<span>def <span class="ident">test_support_bundle_failed_limit</span></span>(<span>client, apps_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test support bundle failed limit</p>
<p>Issue: <a href="https://github.com/longhorn/longhorn/issues/2759">https://github.com/longhorn/longhorn/issues/2759</a></p>
<p>Given support-bundle-failed-history-limit setting is 2
And 2 failed support bundle created</p>
<p>When create support bundle
Then should fail to create</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.mark.support_bundle   # NOQA
def test_support_bundle_failed_limit(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle failed limit

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 2
    And 2 failed support bundle created

    When create support bundle
    Then should fail to create

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;3&#34;)
    create_failed_support_bundles(client, apps_api, number=2)

    try:
        create_failed_support_bundles(client, apps_api, number=1)
        assert False, \
            f&#39;expect to fail exceeding {SETTING_SUPPORT_BUNDLE_FAILED_LIMIT}&#39;
    except Exception:
        pass</code></pre>
</details>
</dd>
<dt id="tests.test_support_bundle.test_support_bundle_purge"><code class="name flex">
<span>def <span class="ident">test_support_bundle_purge</span></span>(<span>client, apps_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test support bundle</p>
<p>Issue: <a href="https://github.com/longhorn/longhorn/issues/2759">https://github.com/longhorn/longhorn/issues/2759</a></p>
<p>Given support-bundle-failed-history-limit setting is 2
And 2 failed support bundle created</p>
<p>When set support-bundle-failed-history-limit setting to 0
Then failed support bundles should be deleted
And support bundle managers should be deleted</p>
<p>When create a failed support bundle
Then failed support bundle should be deleted
And support bundle manager should be deleted</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.mark.support_bundle   # NOQA
def test_support_bundle_purge(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 2
    And 2 failed support bundle created

    When set support-bundle-failed-history-limit setting to 0
    Then failed support bundles should be deleted
    And support bundle managers should be deleted

    When create a failed support bundle
    Then failed support bundle should be deleted
    And support bundle manager should be deleted

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;2&#34;)
    create_failed_support_bundles(client, apps_api, number=2)

    support_bundles = client.list_support_bundle()
    assert len(support_bundles) == 2

    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;0&#34;)
    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()

    # Will try to catch the Error state here because it is an intermediate
    # state
    try:
        create_failed_support_bundles(client, apps_api, number=1)
    except AssertionError:
        pass

    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()</code></pre>
</details>
</dd>
<dt id="tests.test_support_bundle.test_support_bundle_should_delete_after_download"><code class="name flex">
<span>def <span class="ident">test_support_bundle_should_delete_after_download</span></span>(<span>client)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test support bundle should delete after download</p>
<p>Issue: <a href="https://github.com/longhorn/longhorn/issues/2759">https://github.com/longhorn/longhorn/issues/2759</a></p>
<p>Given support bundle created
And support bundle is in ReadyToDownload state</p>
<p>When download support bundle
Then support bundle is downloaded
And support bundle should be deleted
And support bundle manager should be deleted</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.mark.support_bundle   # NOQA
def test_support_bundle_should_delete_after_download(client):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle should delete after download

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support bundle created
    And support bundle is in ReadyToDownload state

    When download support bundle
    Then support bundle is downloaded
    And support bundle should be deleted
    And support bundle manager should be deleted

    &#34;&#34;&#34;
    resp = create_support_bundle(client)
    node_id = resp[&#39;id&#39;]
    name = resp[&#39;name&#39;]

    wait_for_support_bundle_state(&#34;ReadyForDownload&#34;, node_id, name, client)

    download_support_bundle(node_id, name, client)

    wait_for_support_bundle_cleanup(client)
    check_all_support_bundle_managers_deleted()</code></pre>
</details>
</dd>
<dt id="tests.test_support_bundle.test_support_bundle_should_error_when_failed"><code class="name flex">
<span>def <span class="ident">test_support_bundle_should_error_when_failed</span></span>(<span>client, apps_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test support bundle should error when failed</p>
<p>Issue: <a href="https://github.com/longhorn/longhorn/issues/2759">https://github.com/longhorn/longhorn/issues/2759</a></p>
<p>Given support-bundle-failed-history-limit setting is 1
And support bundle created
And support bundle is in Generating state</p>
<p>When delete support bundle manager deployment
Then support bundle should be in state Error</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.mark.support_bundle   # NOQA
def test_support_bundle_should_error_when_failed(client, apps_api):  # NOQA
    &#34;&#34;&#34;
    Scenario: test support bundle should error when failed

    Issue: https://github.com/longhorn/longhorn/issues/2759

    Given support-bundle-failed-history-limit setting is 1
    And support bundle created
    And support bundle is in Generating state

    When delete support bundle manager deployment
    Then support bundle should be in state Error

    &#34;&#34;&#34;
    update_setting(client, SETTING_SUPPORT_BUNDLE_FAILED_LIMIT, &#34;1&#34;)

    create_failed_support_bundles(client, apps_api)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="tests" href="index.html">tests</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="tests.test_support_bundle.create_failed_support_bundles" href="#tests.test_support_bundle.create_failed_support_bundles">create_failed_support_bundles</a></code></li>
<li><code><a title="tests.test_support_bundle.test_support_bundle_failed_limit" href="#tests.test_support_bundle.test_support_bundle_failed_limit">test_support_bundle_failed_limit</a></code></li>
<li><code><a title="tests.test_support_bundle.test_support_bundle_purge" href="#tests.test_support_bundle.test_support_bundle_purge">test_support_bundle_purge</a></code></li>
<li><code><a title="tests.test_support_bundle.test_support_bundle_should_delete_after_download" href="#tests.test_support_bundle.test_support_bundle_should_delete_after_download">test_support_bundle_should_delete_after_download</a></code></li>
<li><code><a title="tests.test_support_bundle.test_support_bundle_should_error_when_failed" href="#tests.test_support_bundle.test_support_bundle_should_error_when_failed">test_support_bundle_should_error_when_failed</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>