<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Longhorn Manual Test Cases
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
  </head>
  <body class="markdown-body" style="display: flex; padding: 1%;">
    
<aside style="width: 30%; padding: 1%; border-right: 1px solid lightgray;">
  <a href="https://longhorn.github.io/longhorn-tests/manual"><h2>Manual Test Cases</h2></a>
  
  <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/">Pre-release tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/">Air Gap</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/air-gap-installation/">Air gap installation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/air-gap-instance-manager-name/">Air gap installation with an instance-manager-image name longer than 63 characters</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/">Backup &amp; Restore tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/dr-volume-live-upgrade-and-rebuild/">#1279 DR volume live upgrade and rebuild</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/concurrent-backup-creation-deletion/">#1326 concurrent backup creation &amp; deletion</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/concurrent-backup/">#1341 concurrent backup test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/restore-volume-node-down/">#1355 The node the restore volume attached to is down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/dr-volume-node-down-rebooted/">#1366 &amp;&amp; #1328 The node the DR volume attached to is down/rebooted</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/google-cloud-s3-interop-backups/">#1404 test backup functionality on google cloud and other s3 interop providers.</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/backup-block-deletion/">#1431 backup block deletion test</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/">Environment</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/k3s-selinux-compatibility/">Compatibility with k3s and SELinux</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/">HA</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/instance-manager-pod-recovery/">Instance manager pod recovery [#870]</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/">Node</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/degraded-availability/">Degraded availability with added nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/improve-node-failure-handling/">Improve Node Failure Handling By Automatically Force Delete Terminating Pods of StatefulSet/Deployment On Downed Node</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-disconnection/">Node disconnection test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-drain-deletion/">Node drain and deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/physical-node-down/">Physical node down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-deletion/">Test node deletion</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/">Test scenarios for auto detach of deployment pod&rsquo;s volume when the node is down</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/deployment/">Workload type: Deployment</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/statefulset/">Workload type: Stateful set</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/">Stability</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/multiple-installation/">Longhorn installation multiple times</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/">Upgrade</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/kubernetes-upgrade-test/">Kubernetes upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/longhorn-upgrade-test/">Longhorn Upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/engine-crash-during-live-upgrade/">Test Engine Crash During Live Upgrade</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-conflict-handling/">Upgrade Conflict Handling test</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/">Release specific tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/">v1.0.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/new-node-custom-data-directory/">New Node with Custom Data Directory</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/">Operating System specific tests for SUSE SLES12SP3</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-1/">Testing ext4 with custom fs params1 (no 64bit, no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-2/">Testing ext4 with custom fs params2 (no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-no-custom-fs-params/">Testing ext4 without custom fs params</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/xfs-after-custom-fs-params/">Testing xfs after custom fs params (xfs should ignore the custom fs params)</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/">v1.0.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/besteffort-recurring-job/">BestEffort Recurring Job Cleanup</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/change-imagepullpolicy/">Change imagePullPolicy to IfNotPresent Test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/dr-volume-latest-backup-deletion/">DR volume related latest backup deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/nfsv4-enforcement/">NFSv4 Enforcement (No NFSv3 Fallback)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/priorityclass-default-setting/">Priority Class Default Setting</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/error-fail-remount/">Return an error when fail to remount a volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-access-style/">Test access style for S3 compatible backupstore</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-backupstore/">Test S3 backupstore in a cluster sitting behind a Http Proxy</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/ui-volume-deletion/">Volume Deletion UI Warnings</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/">v1.0.2</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/upgrade-lease-lock/">Upgrade Lease Lock</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/">v1.1.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/prometheus_support/">Prometheus Support</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/kubelet_volume_metrics/">Support Kubelet Volume Metrics</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/additional-printer-columns/">Test Additional Printer Columns</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/instance-manager-ip-sync/">Test Instance Manager IP Sync</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/uninstallation/">Test uninstallation</a></li>
  

</ul>

  

</ul>

  

</ul>

  
</aside>

<main style="padding: 1%; width: 70%;">
  <h1 id="title">Improve Node Failure Handling By Automatically Force Delete Terminating Pods of StatefulSet/Deployment On Downed Node</h1>
  <div>
    <article id="content">
       <ol>
<li>Setup a cluster of 3 worker nodes</li>
<li>Install Longhorn and set <code>Default Replica Count = 2</code> (because we will turn off one node)</li>
<li>Create a StatefulSet with 2 pods using the command:
<pre><code>kubectl create -f https://raw.githubusercontent.com/longhorn/longhorn/master/examples/statefulset.yaml
</code></pre></li>
<li>Create a volume + pv + pvc named <code>vol1</code> and create a deployment(1 pod) of default ubuntu named <code>shell</code> with the usage of pvc <code>vol1</code> mounted under <code>/mnt/vol1</code></li>
<li>Find the node which contains one pod of the StatefulSet/Deployment. Power off the node</li>
</ol>
<h4 id="statefulset">StatefulSet</h4>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-do-nothing---delete-deployment-pod">if <code>NodeDownPodDeletionPolicy </code> is set to <code>do-nothing </code> | <code>delete-deployment-pod</code></h5>
<ul>
<li>wait till the <code>pod.deletionTimestamp</code> has passed</li>
<li>verify no replacement pod generated, the pod is stuck at terminating forever.</li>
</ul>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-delete-statefulset-pod---delete-both-statefulset-and-deployment-pod">if <code>NodeDownPodDeletionPolicy </code> is set to <code>delete-statefulset-pod </code> | <code>delete-both-statefulset-and-deployment-pod</code></h5>
<ul>
<li>wait till pod&rsquo;s status becomes <code>terminating</code> and the <code>pod.deletionTimestamp</code> has passed (around 7 minutes)</li>
<li>verify that the pod is deleted and there is a new running replacement pod.</li>
<li>Verify that you can access/read/write the volume on the new pod</li>
</ul>
<h4 id="deployment">Deployment</h4>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-do-nothing---delete-statefulset-pod-and-volume-attachment-recovery-policy-is-never">if <code>NodeDownPodDeletionPolicy </code> is set to <code>do-nothing </code> | <code>delete-statefulset-pod</code> AND <code>Volume Attachment Recovery Policy</code> is <code>never</code></h5>
<ul>
<li>wait till the <code>pod.deletionTimestamp</code> has passed</li>
<li>replacement pod will be stuck in <code>Pending</code> state forever</li>
<li>force delete the terminating pod</li>
<li>wait till replacement pod is running</li>
<li>verify that you can access <code>vol1</code> via the <code>shell</code> replacement pod under <code>/mnt/vol1</code> once it is in the running state</li>
</ul>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-do-nothing---delete-statefulset-pod-and-volume-attachment-recovery-policy-is-wait">if <code>NodeDownPodDeletionPolicy </code> is set to <code>do-nothing </code> | <code>delete-statefulset-pod</code> AND <code>Volume Attachment Recovery Policy</code> is <code>wait</code></h5>
<ul>
<li>wait till replacement pod is generated (default is around 6 minutes, kubernetes setting)</li>
<li>wait till the <code>pod.deletionTimestamp</code> has passed</li>
<li>verify that you can access <code>vol1</code> via the <code>shell</code> replacement pod under <code>/mnt/vol1</code> once it is in the running state</li>
<li>verify that the original <code>shell</code> pod is stuck in <code>Pending</code> state forever</li>
</ul>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-do-nothing---delete-statefulset-pod-and-volume-attachment-recovery-policy-is-immediate">if <code>NodeDownPodDeletionPolicy </code> is set to <code>do-nothing </code> | <code>delete-statefulset-pod</code> AND <code>Volume Attachment Recovery Policy</code> is <code>immediate</code></h5>
<ul>
<li>wait till replacement pod is generated (default is around 6 minutes, kubernetes setting)</li>
<li>verify that you can access <code>vol1</code> via the <code>shell</code> replacement pod under <code>/mnt/vol1</code> once it is in the running state</li>
<li>verify that the original <code>shell</code> pod is stuck in <code>Pending</code> state forever</li>
</ul>
<h5 id="if-nodedownpoddeletionpolicy--is-set-to-delete-deployment-pod---delete-both-statefulset-and-deployment-pod-and-volume-attachment-recovery-policy-is-never-waitimmediate">if <code>NodeDownPodDeletionPolicy </code> is set to <code>delete-deployment-pod </code> | <code>delete-both-statefulset-and-deployment-pod</code> AND <code>Volume Attachment Recovery Policy</code> is <code>never</code>| <code>wait</code>|<code>immediate</code></h5>
<ul>
<li>wait till the <code>pod.deletionTimestamp</code> has passed</li>
<li>verify that the pod is deleted and there is a new running replacement pod.</li>
<li>verify that you can access <code>vol1</code> via the <code>shell</code> replacement pod under <code>/mnt/vol1</code></li>
</ul>
<h4 id="other-kinds">Other kinds</h4>
<ul>
<li>Verify that Longhorn never deletes any other pod on the downed node.</li>
</ul>
<h4 id="test-example">Test example</h4>
<p>One typical scenario when the enhancement has succeeded is as below. When a node (say <code>node-x</code>) goes down (assume using Kubernetes' default settings and user allows Longhorn to force delete pods):</p>
<table>
<thead>
<tr>
<th style="text-align:left">Time</th>
<th style="text-align:center">Event</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0m:00s</td>
<td style="text-align:center"><code>node-x</code>goes down and stops sending heartbeats to Kubernetes Node controller</td>
</tr>
<tr>
<td style="text-align:left">0m:40s</td>
<td style="text-align:center">Kubernetes Node controller reports <code>node-x</code> is <code>NotReady</code>.</td>
</tr>
<tr>
<td style="text-align:left">5m:40s</td>
<td style="text-align:center">Kubernetes Node controller starts evicting pods from <code>node-x</code> using graceful termination (set <code>DeletionTimestamp</code> and <code>deletionGracePeriodSeconds = 10s/30s</code>)</td>
</tr>
<tr>
<td style="text-align:left">5m:50s/6m:10s</td>
<td style="text-align:center">Longhorn forces delete the pod of StatefulSet/Deployment which uses Longhorn volume</td>
</tr>
</tbody>
</table>

    </article>
  </div>
</main>

    
    
  </body>
</html>
