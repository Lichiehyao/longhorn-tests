<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Longhorn Manual Test Cases
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
  </head>
  <body class="markdown-body" style="display: flex; padding: 1%;">
    
<aside style="width: 30%; padding: 1%; border-right: 1px solid lightgray;">
  <a href="https://longhorn.github.io/longhorn-tests/manual"><h2>Manual Test Cases</h2></a>
  
  <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/">Pre-release tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/">Air Gap</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/air-gap-installation/">Air gap installation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/air-gap/air-gap-instance-manager-name/">Air gap installation with an instance-manager-image name longer than 63 characters</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/">Backup &amp; Restore tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/dr-volume-live-upgrade-and-rebuild/">#1279 DR volume live upgrade and rebuild</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/concurrent-backup-creation-deletion/">#1326 concurrent backup creation &amp; deletion</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/concurrent-backup/">#1341 concurrent backup test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/restore-volume-node-down/">#1355 The node the restore volume attached to is down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/dr-volume-node-down-rebooted/">#1366 &amp;&amp; #1328 The node the DR volume attached to is down/rebooted</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/google-cloud-s3-interop-backups/">#1404 test backup functionality on google cloud and other s3 interop providers.</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/backup-block-deletion/">#1431 backup block deletion test</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/basic-operations-parallelism/">Basic operations parallelism</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/basic-operations-parallelism/snapshot-while-writing-data/">Snapshot while writing data in the volume</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/">Cluster Restore</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/system-upgrade-with-restore/">Longhorn system upgrade with restore</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/node-creation-deletion-with-restore/">Node creation and deletion with restore</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/recover-volumes-after-restore/">Recover Longhorn volumes after Rancher cluster restore</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/">Environment</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/k3s-selinux-compatibility/">Compatibility with k3s and SELinux</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/rke2-cis-1.5-profile/">Test Longhorn Deployment on RKE2 with CIS-1.5 profile</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/">HA</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/disk-migration-in-aws-asg/">Disk migration in AWS ASG</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/instance-manager-pod-recovery/">Instance manager pod recovery [#870]</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/partial-engine-deployment/">Longhorn with engine is not deployed on all the nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/replica-rebuilding/">Replica Rebuilding</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/single-replica-node-down/">Single replica node down</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/">Node</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/backing-image-on-a-down-node/">Backing Image on a down node</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/degraded-availability/">Degraded availability with added nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/improve-node-failure-handling/">Improve Node Failure Handling By Automatically Force Delete Terminating Pods of StatefulSet/Deployment On Downed Node</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-disconnection/">Node disconnection test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-drain-deletion/">Node drain and deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/physical-node-down/">Physical node down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/node-deletion/">Test node deletion</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/">Test scenarios for auto detach of deployment pod&rsquo;s volume when the node is down</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/deployment/">Workload type: Deployment</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/auto-detach/statefulset/">Workload type: Stateful set</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/">Stability</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/multiple-installation/">Longhorn installation multiple times</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stress/backup-listing/">Test backup listing S3/NFS</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/">Upgrade</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/auto-upgrade-engine/">Automatically Upgrading Longhorn Engine Test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/kubernetes-upgrade-test/">Kubernetes upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/longhorn-upgrade-test/">Longhorn Upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/update_csi_components_when_images_change/">Re-deploy CSI components when their images change</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/backing-image-during-upgrade/">Test Backing Image during Longhorn upgrade</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/engine-crash-during-live-upgrade/">Test Engine Crash During Live Upgrade</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-with-new-instance-manager/">Test System Upgrade with New Instance Manager</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-conflict-handling/">Upgrade Conflict Handling test</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/">Release specific tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/">v1.0.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/new-node-custom-data-directory/">New Node with Custom Data Directory</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/">Operating System specific tests for SUSE SLES12SP3</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-1/">Testing ext4 with custom fs params1 (no 64bit, no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-2/">Testing ext4 with custom fs params2 (no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-no-custom-fs-params/">Testing ext4 without custom fs params</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/xfs-after-custom-fs-params/">Testing xfs after custom fs params (xfs should ignore the custom fs params)</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/">v1.0.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/besteffort-recurring-job/">BestEffort Recurring Job Cleanup</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/change-imagepullpolicy/">Change imagePullPolicy to IfNotPresent Test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/dr-volume-latest-backup-deletion/">DR volume related latest backup deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/nfsv4-enforcement/">NFSv4 Enforcement (No NFSv3 Fallback)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/priorityclass-default-setting/">Priority Class Default Setting</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/error-fail-remount/">Return an error when fail to remount a volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-access-style/">Test access style for S3 compatible backupstore</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-backupstore/">Test S3 backupstore in a cluster sitting behind a Http Proxy</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/ui-volume-deletion/">Volume Deletion UI Warnings</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/">v1.0.2</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/upgrade-lease-lock/">Upgrade Lease Lock</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/">v1.1.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/prometheus_support/">Prometheus Support</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/recurring-backup-job-interruptions/">Recurring backup job interruptions</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/reusing-failed-replica-for-rebuilding/">Reusing failed replica for rebuilding</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/kubelet_volume_metrics/">Support Kubelet Volume Metrics</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/additional-printer-columns/">Test Additional Printer Columns</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/instance-manager-ip-sync/">Test Instance Manager IP Sync</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/iscsi_installation/">Test ISCSI Installation on EKS</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/rwx_feature/">Test Read Write Many Feature</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/uninstallation/">Test uninstallation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/upgrade_with_modified_storageclass/">Upgrade Longhorn with modified Storage Class</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/">v1.1.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/csi-sanity-check/">CSI Sanity Check</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/partial-engine-deployment/">Longhorn with engine is not deployed on all the nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/tolerations_priorityclass_setting/">Set Tolerations/PriorityClass For System Components</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/disable_ipv6/">Test Disable IPv6</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-file-sync-cancellation/">Test File Sync Cancellation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/ws-traffic-flood/">Test Frontend Traffic</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/delete-node/">Test Node Delete</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-node-selector/">Test Node Selector</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/rwx-mount-ownership-reset/">Test RWX share-mount ownership reset</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-service-account-mount/">Test Service Account mount on host</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/snapshot-purge-error-handling/">Test Snapshot Purge Error Handling</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/system-upgrade-with-deprecated-cpu-setting/">Test system upgrade with the deprecated CPU setting</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/aws-iam-role-for-volume-backup-restore/">Test Volume Backup and Restore by AWS IAM role</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/">v1.1.2</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/full-ws-data-tranfer-when-no-updates/">Test Frontend Web-socket Data Transfer When Resource Not Updated</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/instance-manager-streaming-connection-recovery/">Test Instance Manager Streaming Connection Recovery</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/">v1.2.0</a></li>
  
    <ul>

</ul>

  

</ul>

  

</ul>

  
</aside>

<main style="padding: 1%; width: 70%;">
  <h1 id="title">Test Volume Backup and Restore by AWS IAM role</h1>
  <div>
    <article id="content">
       <h2 id="related-issue">Related issue</h2>
<p><a href="https://github.com/longhorn/longhorn/issues/1526">https://github.com/longhorn/longhorn/issues/1526</a></p>
<p>Longhorn v1.1.1 should work with volume backup and restore by AWS IAM role</p>
<h2 id="scenario">Scenario</h2>
<ol>
<li>Install AWS CLI and configure your AWS credentials</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl <span style="color:#e6db74">&#34;https://s3.amazonaws.com/aws-cli/awscli-bundle.zip&#34;</span> -o <span style="color:#e6db74">&#34;awscli-bundle.zip&#34;</span>
unzip awscli-bundle.zip
./awscli-bundle/install -b ~/bin/aws
~/bin/aws configure
</code></pre></div><ol start="2">
<li>Create AWS S3 bucket</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">S3_BUCKET_NAME<span style="color:#f92672">=</span>&lt;bucket-name&gt;

~/bin/aws s3api create-bucket <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --bucket $S3_BUCKET_NAME <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --region us-west-2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --create-bucket-configuration LocationConstraint<span style="color:#f92672">=</span>us-west-2
</code></pre></div><ol start="3">
<li>Create a new IAM instance profile <code>NodeInstanceProfile</code></li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; node-instance-assume-role-policy.json <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style="color:#e6db74">  &#34;Statement&#34;: [
</span><span style="color:#e6db74">    {
</span><span style="color:#e6db74">      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style="color:#e6db74">      &#34;Principal&#34;: {
</span><span style="color:#e6db74">        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
</span><span style="color:#e6db74">      },
</span><span style="color:#e6db74">      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">  ]
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>

~/bin/aws iam create-role <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role-name NodeInstanceRole <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --assume-role-policy-document file://node-instance-assume-role-policy.json

~/bin/aws iam create-instance-profile <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-profile-name NodeInstanceProfile

~/bin/aws iam add-role-to-instance-profile <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --instance-profile-name NodeInstanceProfile <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role-name NodeInstanceRole
</code></pre></div><ol start="4">
<li>Install RKE2 with CNI canal on top of AWS with IAM instance profile name <code>NodeInstanceProfile</code></li>
<li>Prepare kube2iam-values.yaml</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">host</span>:
  <span style="color:#f92672">iptables</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">interface</span>: <span style="color:#e6db74">&#34;cali+&#34;</span>
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
 
<span style="color:#f92672">rbac</span>:
  <span style="color:#f92672">create</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><ol start="6">
<li>Install kube2iam on namespace kube2iam</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">helm repo add kube2iam https://jtblin.github.io/kube2iam/
helm repo update
helm upgrade --install kube2iam kube2iam/kube2iam <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -f kube2iam-values.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -n kube2iam <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --create-namespace
</code></pre></div><ol start="7">
<li>Create a new IAM role <code>k8s-longhorn</code> and attach a trust policy to it</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NODE_INSTANCE_ROLE<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>~/bin/aws iam get-role --role-name NodeInstanceRole | jq -r <span style="color:#e6db74">&#39;.Role.Arn&#39;</span><span style="color:#e6db74">`</span>

cat &gt; node-trust-policy.json <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style="color:#e6db74">  &#34;Statement&#34;: [
</span><span style="color:#e6db74">    {
</span><span style="color:#e6db74">      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style="color:#e6db74">      &#34;Principal&#34;: {
</span><span style="color:#e6db74">        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
</span><span style="color:#e6db74">      },
</span><span style="color:#e6db74">      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
</span><span style="color:#e6db74">    },
</span><span style="color:#e6db74">    {
</span><span style="color:#e6db74">      &#34;Sid&#34;: &#34;&#34;,
</span><span style="color:#e6db74">      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style="color:#e6db74">      &#34;Principal&#34;: {
</span><span style="color:#e6db74">        &#34;AWS&#34;: &#34;$NODE_INSTANCE_ROLE&#34;
</span><span style="color:#e6db74">      },
</span><span style="color:#e6db74">      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">  ]
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>
 
aws iam create-role <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role-name k8s-longhorn <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --assume-role-policy-document <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    file://node-trust-policy.json
 
cat &gt; s3-longhorn-policy.json <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style="color:#e6db74">  &#34;Statement&#34;: [
</span><span style="color:#e6db74">    {
</span><span style="color:#e6db74">      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style="color:#e6db74">      &#34;Action&#34;: [
</span><span style="color:#e6db74">        &#34;s3:PutObject&#34;,
</span><span style="color:#e6db74">        &#34;s3:GetObject&#34;,
</span><span style="color:#e6db74">        &#34;s3:ListBucket&#34;,
</span><span style="color:#e6db74">        &#34;s3:DeleteObject&#34;
</span><span style="color:#e6db74">      ],
</span><span style="color:#e6db74">      &#34;Resource&#34;: [
</span><span style="color:#e6db74">        &#34;arn:aws:s3:::$S3_BUCKET_NAME&#34;,
</span><span style="color:#e6db74">        &#34;arn:aws:s3:::$S3_BUCKET_NAME/*&#34;
</span><span style="color:#e6db74">      ]
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">  ]
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>
 
~/bin/aws iam put-role-policy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role-name k8s-longhorn <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --policy-name s3 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --policy-document file://s3-longhorn-policy.json
</code></pre></div><ol start="8">
<li>Create the secret <code>aws-secret</code> to longhorn-system</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">K8S_LONGHORN_ROLE<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>~/bin/aws iam get-role --role-name k8s-longhorn | jq -r <span style="color:#e6db74">&#39;.Role.Arn&#39;</span><span style="color:#e6db74">`</span>

kubectl create secret generic aws-secret <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --from-literal<span style="color:#f92672">=</span>AWS_IAM_ROLE_ARN<span style="color:#f92672">=</span>$K8S_LONGHORN_ROLE <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -n longhorn-system
</code></pre></div><ol start="9">
<li>On the Longhorn UI, click Settings. In the Backup section, set Backup Target to:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">s3://&lt;your-bucket-name&gt;@&lt;your-aws-region&gt;/
</code></pre></div><ol start="10">
<li>In the Backup section, set Backup Target Credential Secret to:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">aws-secret
</code></pre></div><ol start="11">
<li>Verify that the user is able to create/list/restore/delete backups.</li>
</ol>

    </article>
  </div>
</main>

    
    
  </body>
</html>
